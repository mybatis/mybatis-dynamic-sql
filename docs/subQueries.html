<!DOCTYPE html>


<!--
 | Generated by Apache Maven Doxia Site Renderer 1.11.1 from src/site/markdown/docs/subQueries.md at 07 October 2022
 | Rendered using Apache Maven Fluido Skin 1.11.1
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.11.1" />
    <title>MyBatis Dynamic SQL &#x2013; Subquery Support</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.11.1.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
    <script src="../js/apache-maven-fluido-1.11.1.min.js"></script>
  </head>
  <body class="topBarDisabled">
    <div class="container-fluid">
      <header>
        <div id="banner">
          <div class="pull-left"><a href="../docs/introduction.html" id="bannerLeft"><h1>MyBatis Dynamic SQL</h1>
</a></div>
          <div class="pull-right"><a href="http://www.mybatis.org/" id="bannerRight" title="MyBatis logo"><img src="https://mybatis.org/images/mybatis-logo.png"  alt="MyBatis logo" style="" /></a></div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
        <li id="publishDate">Last Published: 07 October 2022<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 1.4.1</li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">User's Guide</li>
    <li><a href="../docs/introduction.html" title="Introduction"><span class="none"></span>Introduction</a></li>
    <li><a href="../docs/CHANGELOG.html" title="Change Log"><span class="none"></span>Change Log</a></li>
    <li><a href="../docs/quickStart.html" title="Quick Start"><span class="none"></span>Quick Start</a></li>
    <li><a href="../docs/exceptions.html" title="Exceptions thrown by the Library"><span class="none"></span>Exceptions thrown by the Library</a></li>
    <li><a href="../docs/configuration.html" title="Configuration of the Library"><span class="none"></span>Configuration of the Library</a></li>
    <li><a href="../docs/databaseObjects.html" title="Modeling Database Objects"><span class="none"></span>Modeling Database Objects</a></li>
    <li><a href="../docs/whereClauses.html" title="WHERE Clause Support"><span class="icon-chevron-down"></span>WHERE Clause Support</a>
     <ul class="nav nav-list">
      <li><a href="../docs/conditions.html" title="WHERE Conditions"><span class="none"></span>WHERE Conditions</a></li>
     </ul></li>
    <li><a href="../docs/select.html" title="SELECT Statements"><span class="icon-chevron-down"></span>SELECT Statements</a>
     <ul class="nav nav-list">
      <li><a href="../docs/complexQueries.html" title="Complex Queries"><span class="none"></span>Complex Queries</a></li>
     </ul></li>
    <li><a href="../docs/delete.html" title="DELETE Statements"><span class="none"></span>DELETE Statements</a></li>
    <li><a href="../docs/insert.html" title="INSERT Statements"><span class="none"></span>INSERT Statements</a></li>
    <li><a href="../docs/update.html" title="UPDATE Statements"><span class="none"></span>UPDATE Statements</a></li>
    <li class="active"><a><span class="none"></span>SubQuery Support</a></li>
    <li><a href="../docs/functions.html" title="Database Functions"><span class="none"></span>Database Functions</a></li>
    <li><a href="../docs/mybatis3.html" title="MyBatis3 Support"><span class="none"></span>MyBatis3 Support</a></li>
    <li><a href="../docs/spring.html" title="Spring Support"><span class="none"></span>Spring Support</a></li>
    <li><a href="../docs/springBatch.html" title="Spring Batch Support"><span class="none"></span>Spring Batch Support</a></li>
    <li><a href="../docs/kotlinOverview.html" title="Kotlin Support"><span class="icon-chevron-right"></span>Kotlin Support</a></li>
    <li><a href="../docs/howItWorks.html" title="How it Works"><span class="none"></span>How it Works</a></li>
    <li><a href="../docs/extending.html" title="Extending the Library"><span class="none"></span>Extending the Library</a></li>
    <li><a href="../docs/codingStandards.html" title="Coding Standards"><span class="none"></span>Coding Standards</a></li>
    <li><a href="../docs/motivation.html" title="Motivation"><span class="none"></span>Motivation</a></li>
   <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn"  class="span10" >
<h1>Subquery Support</h1>
<p>The library currently supports subqueries in the following areas:</p>
<ol style="list-style-type: decimal">

<li>In where clauses - both with the &#x201c;exists&#x201d; operator and with column-based conditions</li>
<li>In certain insert statements</li>
<li>In update statements</li>
<li>In the &#x201c;from&#x201d; clause of a select statement</li>
<li>In join clauses of a select statement</li>
</ol>
<p>Before we show examples of subqueries, it is important to understand how the library generates and applies
table qualifiers in select statements. We'll cover that first.</p><section>
<h2><a name="Table_Qualifiers_in_Select_Statements"></a>Table Qualifiers in Select Statements</h2>
<p>The library attempts to automatically calculate table qualifiers. If a table qualifier is specified,
the library will automatically render the table qualifier on all columns associated with the
table. For example with the following query:</p>

<div class="source"><pre class="prettyprint"><code class="language-java">SelectStatementProvider selectStatement =
    select(id, animalName)
    .from(animalData, &quot;ad&quot;)
    .build()
    .render(RenderingStrategies.MYBATIS3);
</code></pre></div>
<p>The library will render SQL as:</p>

<div class="source"><pre class="prettyprint"><code class="language-sql">select ad.id, ad.animal_name
from AnimalData ad
</code></pre></div>
<p>Notice that the table qualifier <code>ad</code> is automatically applied to columns in the select list.</p>
<p>In the case of join queries the table qualifier specified, or if not specified the table name
itself, will be used as the table qualifier. However, this function is disabled for joins on subqueries.</p>
<p>With subqueries, it is important to understand the limits of automatic table qualifiers. The rules are
as follows:</p>
<ol style="list-style-type: decimal">

<li>The scope of automatic table qualifiers is limited to a single select statement. For subqueries, the outer
query has a different scope than the subquery.</li>
<li>A qualifier can be applied to a subquery, but that qualifier is not automatically applied to
any column</li>
</ol>
<p>As an example, consider the following query:</p>

<div class="source"><pre class="prettyprint"><code class="language-java">DerivedColumn&lt;Integer&gt; rowNum = DerivedColumn.of(&quot;rownum()&quot;);

SelectStatementProvider selectStatement =
    select(animalName, rowNum)
    .from(
        select(id, animalName)
        .from(animalData, &quot;a&quot;)
        .where(id, isLessThan(22))
        .orderBy(animalName.descending()),
        &quot;b&quot;
    )
    .where(rowNum, isLessThan(5))
    .and(animalName, isLike(&quot;%a%&quot;))
    .build()
    .render(RenderingStrategies.MYBATIS3);
</code></pre></div>
<p>The rendered SQL will be as follows:</p>

<div class="source"><pre class="prettyprint"><code class="language-sql">select animal_name, rownum()
from (select a.id, a.animal_name
      from AnimalDate a
      where id &lt; #{parameters.p1}
      order by animal_name desc) b
where rownum() &lt; #{parameters.p2}
  and animal_name like  #{parameters.p3} 
</code></pre></div>
<p>Notice that the qualifier <code>a</code> is automatically applied to columns in the subquery and that the
qualifier <code>b</code> is not applied anywhere.</p>
<p>If your query requires the subquery qualifier to be applied to columns in the outer select list,
you can manually apply the qualifier to columns as follows:</p>

<div class="source"><pre class="prettyprint"><code class="language-java">DerivedColumn&lt;Integer&gt; rowNum = DerivedColumn.of(&quot;rownum()&quot;);

SelectStatementProvider selectStatement =
    select(animalName.qualifiedWith(&quot;b&quot;), rowNum)
    .from(
        select(id, animalName)
        .from(animalData, &quot;a&quot;)
        .where(id, isLessThan(22))
        .orderBy(animalName.descending()),
        &quot;b&quot;
    )
    .where(rowNum, isLessThan(5))
    .and(animalName.qualifiedWith(&quot;b&quot;), isLike(&quot;%a%&quot;))
    .build()
    .render(RenderingStrategies.MYBATIS3);
</code></pre></div>
<p>In this case, we have manually applied the qualifier <code>b</code> to columns in the outer query. The
rendered SQL looks like this:</p>

<div class="source"><pre class="prettyprint"><code class="language-sql">select b.animal_name, rownum()
from (select a.id, a.animal_name
      from AnimalDate a
      where id &lt; #{parameters.p1}
      order by animal_name desc) b
where rownum() &lt; #{parameters.p2}
  and b.animal_name like  #{parameters.p3} 
</code></pre></div></section><section>
<h2><a name="Subqueries_in_Where_Conditions"></a>Subqueries in Where Conditions</h2>
<p>The library support subqueries in the following where conditions:</p>
<ul>

<li>exists</li>
<li>notExists</li>
<li>isEqualTo</li>
<li>isNotEqualTo</li>
<li>isIn</li>
<li>isNotIn</li>
<li>isGreaterThan</li>
<li>isGreaterThanOrEqualTo</li>
<li>isLessThan</li>
<li>isLessThanOrEqualTo</li>
</ul>
<p>An example of an exists subquery is as follows:</p>

<div class="source"><pre class="prettyprint"><code class="language-java">SelectStatementProvider selectStatement = select(itemMaster.allColumns())
        .from(itemMaster, &quot;im&quot;)
        .where(exists(
                select(orderLine.allColumns())
                .from(orderLine, &quot;ol&quot;)
                .where(orderLine.itemId, isEqualTo(itemMaster.itemId))
        ))
        .orderBy(itemMaster.itemId)
        .build()
        .render(RenderingStrategies.MYBATIS3);
</code></pre></div>
<p>Note that the qualifier for the outer query (&#x201c;im&#x201d;) is automatically applied to the inner query, as well as the
qualifier for the inner query (&#x201c;ol&#x201d;). Carrying alias from an outer query to an inner query is only supported with
exists or not exists sub queries.</p>
<p>An example of a column based subquery is as follows:</p>

<div class="source"><pre class="prettyprint"><code class="language-java">SelectStatementProvider selectStatement = select(id, animalName, bodyWeight, brainWeight)
        .from(animalData)
        .where(brainWeight, isEqualTo(
                select(min(brainWeight))
                .from(animalData)
            )
        )
        .orderBy(animalName)
        .build()
        .render(RenderingStrategies.MYBATIS3);
</code></pre></div><section>
<h3><a name="Kotlin_Support"></a>Kotlin Support</h3>
<p>The library includes Kotlin versions of the where conditions that allow use of the Kotlin subquery builder. The Kotlin
where conditions are in the <code>org.mybatis.dynamic.sql.util.kotlin</code> package.</p>
<p>An example of an exists subquery is as follows:</p>

<div class="source"><pre class="prettyprint"><code class="language-kotlin">val selectStatement = select(ItemMaster.allColumns()) {
    from(ItemMaster, &quot;im&quot;)
    where {
       exists {
          select(OrderLine.allColumns()) {
             from(OrderLine, &quot;ol&quot;)
             where { OrderLine.itemId isEqualTo ItemMaster.itemId }
          }
       }
       orderBy(ItemMaster.itemId)
    }
}
</code></pre></div>
<p>An example of a column based subquery is as follows:</p>

<div class="source"><pre class="prettyprint"><code class="language-kotlin">val selectStatement = select(id, firstName, lastName, birthDate, employed, occupation, addressId) {
    from(Person)
    where {
       id isEqualTo {
          select(max(id)) {
             from(Person)
          }
       }
    }
}
</code></pre></div></section></section><section>
<h2><a name="Subqueries_in_Insert_Statements"></a>Subqueries in Insert Statements</h2>
<p>The library supports an INSERT statement that retrieves values from a SELECT statement. For example:</p>

<div class="source"><pre class="prettyprint"><code class="language-java">InsertSelectStatementProvider insertSelectStatement = insertInto(animalDataCopy)
        .withColumnList(id, animalName, bodyWeight, brainWeight)
        .withSelectStatement(
            select(id, animalName, bodyWeight, brainWeight)
            .from(animalData)
            .where(id, isLessThan(22))
        )
        .build()
        .render(RenderingStrategies.MYBATIS3);
</code></pre></div><section>
<h3><a name="Kotlin_Support"></a>Kotlin Support</h3>
<p>The library includes a Kotlin builder for subqueries in insert statements that integrates with the select DSL. You
can write inserts like this:</p>

<div class="source"><pre class="prettyprint"><code class="language-kotlin">val insertStatement = insertSelect(Person) {
    columns(id, firstName, lastName, birthDate, employed, occupation, addressId)
    select(add(id, constant&lt;Int&gt;(&quot;100&quot;)), firstName, lastName, birthDate, employed, occupation, addressId) {
        from(Person)
        orderBy(id)
    }
}
</code></pre></div></section></section><section>
<h2><a name="Subqueries_in_Update_Statements"></a>Subqueries in Update Statements</h2>
<p>The library supports setting update values based on the results of a subquery. For example:</p>

<div class="source"><pre class="prettyprint"><code class="language-java">UpdateStatementProvider updateStatement = update(animalData)
        .set(brainWeight).equalTo(
            select(avg(brainWeight))
            .from(animalData)
            .where(brainWeight, isGreaterThan(22.0))
        )
        .where(brainWeight, isLessThan(1.0))
        .build()
        .render(RenderingStrategies.MYBATIS3);
</code></pre></div><section>
<h3><a name="Kotlin_Support"></a>Kotlin Support</h3>
<p>The library includes a Kotlin builder for subqueries in update statements that integrates
with the select DSL. You can write subqueries like this:</p>

<div class="source"><pre class="prettyprint"><code class="language-kotlin">val updateStatement = update(Person) {
    set(addressId) equalToQueryResult {
        select(add(max(addressId), constant&lt;Int&gt;(&quot;1&quot;))) {
            from(Person)
        }
    }
    where { id isEqualTo 3 }
}
</code></pre></div>
<p>Note the Kotlin method name is <code>set(xxx).equalToQueryResult(...)</code> - this is to avoid a collison with
other methods in the update DSL.</p></section></section><section>
<h2><a name="Subqueries_in_a_From_Clause"></a>Subqueries in a From Clause</h2>
<p>The library supports subqueries in from clauses and the syntax is a natural extension of the
select DSL. An example is as follows:</p>

<div class="source"><pre class="prettyprint"><code class="language-java">DerivedColumn&lt;Integer&gt; rowNum = DerivedColumn.of(&quot;rownum()&quot;);

SelectStatementProvider selectStatement =
    select(animalName, rowNum)
    .from(
        select(id, animalName)
        .from(animalData)
        .where(id, isLessThan(22))
        .orderBy(animalName.descending())
    )
    .where(rowNum, isLessThan(5))
    .and(animalName, isLike(&quot;%a%&quot;))
    .build()
    .render(RenderingStrategies.MYBATIS3);
</code></pre></div>
<p>Notice the use of a <code>DerivedColumn</code> to easily specify a function like <code>rownum()</code> that can be
used both in the select list and in a where condition.</p><section>
<h3><a name="Kotlin_Support"></a>Kotlin Support</h3>
<p>The library includes a Kotlin builder for subqueries that integrates with the select DSL. You
can write queries like this:</p>

<div class="source"><pre class="prettyprint"><code class="language-kotlin">val selectStatement =
    select(firstName, rowNum) {
        from {
            select(id, firstName) {
                from(Person)
                where { id isLessThan 22 }
                orderBy(firstName.descending())
            }
        }
        where { rowNum isLessThan 5 }
        and { firstName isLike &quot;%a%&quot; }
    }
</code></pre></div>
<p>The same rules about table qualifiers apply as stated above. In Kotlin, a subquery qualifier
can be added with the overloaded &#x201c;+&#x201d; operator as shown below:</p>

<div class="source"><pre class="prettyprint"><code class="language-kotlin">val selectStatement =
    select(firstName, rowNum) {
        from {
            select(id, firstName) {
                from(Person, &quot;a&quot;)
                where { id isLessThan 22 }
                orderBy(firstName.descending())
            }
            + &quot;b&quot;
        }
        where { rowNum isLessThan 5 }
        and { firstName isLike &quot;%a%&quot; }
    }
</code></pre></div>
<p>In this case the <code>a</code> qualifier is used in the context of the inner select statement and
the <code>b</code> qualifier is applied to the subquery as a whole.</p></section></section><section>
<h2><a name="Subqueries_in_Join_Clauses"></a>Subqueries in Join Clauses</h2>
<p>The library supports subqueries in &#x201c;join&#x201d; clauses similarly to subqueries in &#x201c;from&#x201d; clauses. For example:</p>

<div class="source"><pre class="prettyprint"><code class="language-java">SelectStatementProvider selectStatement = select(orderMaster.orderId, orderMaster.orderDate,
        orderDetail.lineNumber, orderDetail.description, orderDetail.quantity)
    .from(orderMaster, &quot;om&quot;)
    .join(
        select(orderDetail.orderId, orderDetail.lineNumber, orderDetail.description, orderDetail.quantity)
        .from(orderDetail),
        &quot;od&quot;)
    .on(orderMaster.orderId, equalTo(orderDetail.orderId.qualifiedWith(&quot;od&quot;)))
    .build()
    .render(RenderingStrategies.MYBATIS3);
</code></pre></div>
<p>This is rendered as:</p>

<div class="source"><pre class="prettyprint"><code class="language-sql">select om.order_id, om.order_date, line_number, description, quantity
from OrderMaster om
join (select order_id, line_number, description, quantity from OrderDetail) od
on om.order_id = od.order_id
</code></pre></div>
<p>Notice that the subquery is aliased with &#x201c;od&#x201d;, but that alias is not automatically applied so it must
be specified when required. If in doubt, specify the alias with the <code>qualifiedBy</code> method.</p><section>
<h3><a name="Kotlin_Support"></a>Kotlin Support</h3>
<p>The Kotlin select build supports subqueries in joins as follows:</p>

<div class="source"><pre class="prettyprint"><code class="language-kotlin">val selectStatement = select(OrderLine.orderId, OrderLine.quantity,
        &quot;im&quot;(ItemMaster.itemId), ItemMaster.description) {
    from(OrderMaster, &quot;om&quot;)
    join(OrderLine, &quot;ol&quot;) {
        on(OrderMaster.orderId) equalTo OrderLine.orderId
    }
    leftJoin(
       {
          select(ItemMaster.allColumns()) {
             from(ItemMaster)
          }
          + &quot;im&quot;
      }
    ) {
        on(OrderLine.itemId) equalTo &quot;im&quot;(ItemMaster.itemId)
    }
    orderBy(OrderLine.orderId, ItemMaster.itemId)
}
</code></pre></div>
<p>This is rendered as:</p>

<div class="source"><pre class="prettyprint"><code class="language-sql">select ol.order_id, ol.quantity, im.item_id, description
from OrderMaster om join OrderLine ol on om.order_id = ol.order_id
left join (select * from ItemMaster) im on ol.item_id = im.item_id
order by order_id, item_id
</code></pre></div>
<p>Notice again that sub query qualifiers must be specified when needed. In this case we use a Kotlin trick - an invoke
operator function that gets close to natural SQL syntax (<code>&quot;im&quot;(ItemMaster.itemId)</code>).  Also note that the Kotlin
join methods accept two lambda functions - one for the sub query and one for the join specification. Only the join
specification can be outside the parenthesis of the join methods.</p></section></section>
        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>&#169;      2016&#x2013;2022
<a href="https://www.mybatis.org/">MyBatis.org</a>
</p>
        </div>
      </div>
    </footer>
<script>
	if(anchors) {
	  anchors.add();
	}
</script>
  </body>
</html>
