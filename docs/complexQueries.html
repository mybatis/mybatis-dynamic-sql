<!DOCTYPE html>
<!--
 | Generated by Apache Maven Doxia Site Renderer 1.8.1 from src/site/markdown/docs/complexQueries.md at 23 November 2019
 | Rendered using Apache Maven Fluido Skin 1.7
-->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="Date-Revision-yyyymmdd" content="20191123" />
    <meta http-equiv="Content-Language" content="en" />
    <title>MyBatis Dynamic SQL &#x2013; Complex Queries</title>
    <link rel="stylesheet" href="../css/apache-maven-fluido-1.7.min.css" />
    <link rel="stylesheet" href="../css/site.css" />
    <link rel="stylesheet" href="../css/print.css" media="print" />
    <script type="text/javascript" src="../js/apache-maven-fluido-1.7.min.js"></script>
  </head>
  <body class="topBarDisabled">
    <div class="container-fluid">
      <div id="banner">
        <div class="pull-left"><a href="../docs/introduction.html" id="bannerLeft"><h2>MyBatis Dynamic SQL</h2>
</a></div>
        <div class="pull-right"><a href="../../" id="bannerRight" title="MyBatis logo"><img src="http://mybatis.github.io/images/mybatis-logo.png"  alt="MyBatis logo"/></a></div>
        <div class="clear"><hr/></div>
      </div>

      <div id="breadcrumbs">
        <ul class="breadcrumb">
        <li id="publishDate">Last Published: 23 November 2019<span class="divider">|</span>
</li>
          <li id="projectVersion">Version: 1.1.4</li>
        </ul>
      </div>
      <div class="row-fluid">
        <div id="leftColumn" class="span2">
          <div class="well sidebar-nav">
    <ul class="nav nav-list">
      <li class="nav-header">User's Guide</li>
    <li><a href="../docs/introduction.html" title="Introduction"><span class="none"></span>Introduction</a></li>
    <li><a href="../docs/CHANGELOG.html" title="Change Log"><span class="none"></span>Change Log</a></li>
    <li><a href="../docs/quickStart.html" title="Quick Start"><span class="none"></span>Quick Start</a></li>
    <li><a href="../docs/databaseObjects.html" title="Modeling Database Objects"><span class="none"></span>Modeling Database Objects</a></li>
    <li><a href="../docs/whereClauses.html" title="WHERE Clause Support"><span class="icon-chevron-down"></span>WHERE Clause Support</a>
    <ul class="nav nav-list">
    <li><a href="../docs/conditions.html" title="WHERE Conditions"><span class="none"></span>WHERE Conditions</a></li>
    </ul>
</li>
    <li><a href="../docs/select.html" title="SELECT Statements"><span class="icon-chevron-down"></span>SELECT Statements</a>
    <ul class="nav nav-list">
    <li class="active"><a href="#"><span class="none"></span>Complex Queries</a></li>
    </ul>
</li>
    <li><a href="../docs/delete.html" title="DELETE Statements"><span class="none"></span>DELETE Statements</a></li>
    <li><a href="../docs/insert.html" title="INSERT Statements"><span class="none"></span>INSERT Statements</a></li>
    <li><a href="../docs/update.html" title="UPDATE Statements"><span class="none"></span>UPDATE Statements</a></li>
    <li><a href="../docs/mybatis3.html" title="MyBatis3 Support"><span class="none"></span>MyBatis3 Support</a></li>
    <li><a href="../docs/kotlinMyBatis3.html" title="Kotlin Support for MyBatis3"><span class="none"></span>Kotlin Support for MyBatis3</a></li>
    <li><a href="../docs/spring.html" title="Spring Support"><span class="none"></span>Spring Support</a></li>
    <li><a href="../docs/kotlinSpring.html" title="Kotlin Support for Spring"><span class="none"></span>Kotlin Support for Spring</a></li>
    <li><a href="../docs/springBatch.html" title="Spring Batch Support"><span class="none"></span>Spring Batch Support</a></li>
    <li><a href="../docs/howItWorks.html" title="How it Works"><span class="none"></span>How it Works</a></li>
    <li><a href="../docs/extending.html" title="Extending the Library"><span class="none"></span>Extending the Library</a></li>
    <li><a href="../docs/codingStandards.html" title="Coding Standards"><span class="none"></span>Coding Standards</a></li>
    <li><a href="../docs/motivation.html" title="Motivation"><span class="none"></span>Motivation</a></li>
      <li class="nav-header">Project Documentation</li>
    <li><a href="../project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="../project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
</ul>
          <hr />
          <div id="poweredBy">
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
            <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="../images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </div>
        <div id="bodyColumn"  class="span10" >
<h1>Complex Queries</h1>
<p>Enhancements in version 1.1.2 make it easier to code complex queries. The Select DSL is implemented as a set of related objects. As the select statement is built, intermediate objects of various types are returned from the various methods that implement the DSL. The select statement can be completed by calling the <tt>build()</tt> method many of the intermediate objects. Prior to version 1.1.2, it was necessary to call <tt>build()</tt> on the <b>last</b> intermediate object. This restriction has been removed and it is now possible to call <tt>build()</tt> on <b>any</b> intermediate object. This, along with several other enhancements, has simplified the coding of complex queries.</p>
<p>For example, suppose you want to code a complex search on a Person table. The search parameters are id, first name, and last name. The rules are:</p>
<ol style="list-style-type: decimal">

<li>If an id is entered, use the id and ignore the other search parameters</li>
<li>If an id is not entered, then do a fuzzy search based on the other parameters</li>
</ol>
<p>This can be implemented with code like the following&#x2026;</p>

<div>
<div>
<pre class="source">public SelectStatementProvider search(Integer targetId, String fName, String lName) {
    var builder = select(id, firstName, lastName)    // (1)
            .from(person)
            .where();    // (2)
        
    if (targetId != null) {    // (3)
        builder
            .and(id, isEqualTo(targetId));
    } else {
        builder
            .and(firstName, isLike(fName).when(Objects::nonNull).then(s -&gt; &quot;%&quot; + s + &quot;%&quot;))    // (4)
            .and(lastName, isLikeWhenPresent(lName).then(this::addWildcards));    // (5)
    }

    builder
        .orderBy(lastName, firstName)
        .fetchFirst(50).rowsOnly();    // (6)
        
    return builder.build().render(RenderingStrategies.MYBATIS3);    // (7)
}
    
public String addWildcards(String s) {
    return &quot;%&quot; + s + &quot;%&quot;;
}
</pre></div></div>

<p>Notes:</p>
<ol style="list-style-type: decimal">

<li>Note the use of the <tt>var</tt> keyword here. If you are using an older version of Java, the actual type is <tt>QueryExpressionDSL&lt;SelectModel&gt;.QueryExpressionWhereBuilder</tt></li>
<li>Here we are calling <tt>where()</tt> with no parameters. This sets up the builder to accept conditions further along in the code. If no conditions are added, then the where clause will not be rendered</li>
<li>This <tt>if</tt> statement implements the rules of the search. If an ID is entered , use it. Otherwise do a fuzzy search based on first name and last name.</li>
<li>The <tt>then</tt> statement on this line allows you to change the parameter value before it is placed in the parameter Map. In this case we are adding SQL wildcards to the start and end of the search String - but only if the search String is not null. If the search String is null, the lambda will not be called and the condition will not render</li>
<li>This shows using a method reference instead of a lambda on the <tt>then</tt>. Method references allow you to more clearly express intent. Note also the use of the <tt>isLikeWhenPresent</tt> condition which is a built in condition that checks for nulls</li>
<li>It is a good idea to limit the number of rows returned from a search. The library now supports <tt>fetch first</tt> syntax for limiting rows</li>
<li>Note that we are calling the <tt>build</tt> method from the intermediate object retrieved in step 1. It is no longer necessary to call <tt>build</tt> on the last object returned from a select builder</li>
</ol>
        </div>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p>Copyright &copy;2016&#x2013;2019
<a href="http://www.mybatis.org/">MyBatis.org</a>.
All rights reserved.</p>
        </div>
      </div>
    </footer>
  </body>
</html>
